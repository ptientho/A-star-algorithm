name: build & test (Ubuntu matrix)

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    strategy:
      matrix:
        os: [ ubuntu-22.04, ubuntu-24.04 ]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', '**/src/**') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential make cmake ccache pkg-config git wget curl \
            libeigen3-dev

      - name: Install Magick 7 library
        run: |
          cd $HOME
          git clone --depth 1 --branch [latest_release_tag] https://github.com/ImageMagick/ImageMagick.git ImageMagick-7.1.2
          cd ImageMagick-7.1.2
          # Configure and Build
          ./configure
          make
          # Install
          sudo make install
          # Configure the dynamic linker run-time bindings
          sudo ldconfig /usr/local/lib

      - name: Clean previous build
        run: |
          if [ -d build ]; then
          echo "Removing stale build directory"
          rm -rf build
          fi

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INSTALL_PREFIX=./

      - name: Build
        run: cmake --build build --parallel

      - name: Install into workspace (local install)
        run: cmake --install build --verbose

      - name: Run tests
        run: |
          set -o pipefail
          ctest --test-dir build --output-on-failure | tee test_output.txt
          if ! grep -q "100% tests passed" test_output.txt; then
            echo "Some tests failed (see test_output.txt)."
            exit 1
          fi

      - name: Upload build artifact (binary)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: astar_search-binary
          path: |
            build/astar_search
            build/src/astar_search/astar_search
          retention-days: 5

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: ./test_output.txt
          retention-days: 5

      - name: Show build summary
        if: always()
        run: |
          echo "Build finished. Contents of build/:"
          ls -al build || true
          echo "Installed CMake cache:"
          sed -n '1,200p' build/CMakeCache.txt || true
